<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PolyChat</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 30px auto; }
    input, select, button { margin: 5px; padding: 5px; }
    #chatbox { list-style: none; padding: 0; }
    .message { margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
    .username { font-weight: bold; }
    .original { color: gray; font-size: 0.9em; }
    .translated { font-size: 1.1em; margin: 5px 0; }
    .tts-button { cursor: pointer; margin-left: 10px; }
  </style>
</head>
<body>
  <h2>🌍 PolyChat - Real-Time Translation</h2>

  <label>Username: <input id="username" /></label><br/>
  <label>Language:
    <select id="language">
      <option value="en">English</option>
      <option value="fr">French</option>
      <option value="zh-cn">Chinese</option>
    </select>
  </label><br/>

  <input id="message" placeholder="Type a message..." />
  <button onclick="send()">Send</button>

  <ul id="chatbox"></ul>

  <script>
    const socket = new WebSocket('ws://localhost:8080');

    socket.onopen = () => console.log("✅ WebSocket connected!");

    const ttsAudioMap = new Map();  // Store audio per message

    socket.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        console.log("📩 Received:", data);

        if (data.audio) {
          // 用 base64 生成 Blob，存进 map
          const audioBlob = base64ToBlob(data.audio, 'audio/mp3');
          const audioUrl = URL.createObjectURL(audioBlob);
          ttsAudioMap.set(ttsAudioMap.size, audioUrl); // 用 index 当 key
        } else if (data.message) {
          const chatbox = document.getElementById('chatbox');
          const index = ttsAudioMap.size;

          const li = document.createElement('li');
          li.className = 'message';

          li.innerHTML = `
            <div class="username">${data.username}</div>
            <div class="translated">${data.message}</div>
            <div class="original">(original: <i>${data.original || '[unknown]'}</i>)</div>
            <button class="tts-button" onclick="playAudio(${index})">🔊 Play</button>
          `;
          chatbox.appendChild(li);
        }
      } catch (e) {
        console.error("WebSocket error:", e);
      }
    };

    function send() {
      const username = document.getElementById('username').value.trim();
      const message = document.getElementById('message').value.trim();
      const language = document.getElementById('language').value;

      if (!username || !message) {
        alert("Please enter both username and message.");
        return;
      }

      socket.send(JSON.stringify({ username, message, language }));
      document.getElementById('message').value = '';
    }

    function base64ToBlob(base64, mime) {
      const byteChars = atob(base64);
      const byteArrays = [];
      for (let i = 0; i < byteChars.length; i += 512) {
        const slice = byteChars.slice(i, i + 512);
        const byteNumbers = new Array(slice.length);
        for (let j = 0; j < slice.length; j++) {
          byteNumbers[j] = slice.charCodeAt(j);
        }
        byteArrays.push(new Uint8Array(byteNumbers));
      }
      return new Blob(byteArrays, { type: mime });
    }

    function playAudio(index) {
      const url = ttsAudioMap.get(index);
      if (!url) {
        alert("No audio available yet!");
        return;
      }
      const audio = new Audio(url);
      audio.play().catch(err => console.warn("Audio play blocked:", err));
    }
  </script>
</body>
</html>
